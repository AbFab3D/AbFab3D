<!DOCTYPE html >
<html >
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<script type="text/javascript" src="javascript/jquery/jquery-1.7.1.min.js"></script>
<script type="text/javascript" src="javascript/jquery/jquery-ui-1.8.14.custom.min.js"></script>
<script type="text/javascript" src="javascript/jquery/jquery.tools.min.js"></script>
<script type="text/javascript" src="javascript/jquery/jquery.form.js"></script>
<script type="text/javascript" src="javascript/jquery/gpu.realtime.js"></script>
<script type="text/javascript" src="javascript/jquery/md5.js"></script>
<script type="text/javascript" src="javascript/jquery/sylvester.js"></script>

<link rel="stylesheet" type="text/css" href="stylesheets/main.css"/>
<link rel="stylesheet" type="text/css" href="stylesheets/screen.css"/>

<link rel="stylesheet" href="stylesheets/codemirror.css">
<link rel="stylesheet" href="javascript/codemirror/theme/eclipse.css">
<link rel="stylesheet" href="javascript/codemirror/addons/lint.css">
<script src="javascript/codemirror/codemirror.js"></script>
<script src="javascript/codemirror/addons/lint.js"></script>
<script src="javascript/codemirror/addons/javascript-lint.js"></script>
<script src="javascript/codemirror/addons/matchbrackets.js"></script>
<script src="javascript/codemirror/addons/mark-selection.js"></script>
<script src="javascript/codemirror/addons/placeholder.js"></script>
<script src="javascript/codemirror/addons/active-line.js"></script>
<script src="javascript/codemirror/mode/javascript.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jshint/r07/jshint.js"></script>
</head>
<body class="sct-home">
<script type="text/javascript">

var paramData = {};
var paramRequired = {};
var deltaParams = [];   // Keep track of script parameters that have changed
var paramDef = {};

var imageViewer;
var viewMatrix;

var dragStart = {};
var mouseDown = false;
var loading = false;
var pickMode = false;
var pickDataContainer = null;
var scriptChanged = false;
var curLocButton = null;

var degreeByArrow = 10;
var radiansByArrow = (degreeByArrow / 180) * 3.14159;

/** Creator specific vars and methods */

var inputTypes = ["string", "uri", "double","location","enum","boolean","rotation"];

var isUriImage = false;
var isUrlScript = false;
var paramCount = 0;
var fileCount = 0;
var userID;

jQuery(document).ready(function() {
  unspin();
  imageViewer = document.getElementById("image-viewer");
  addMouseEventListeners();

  viewMatrix = $M([
    [1, 0, 0, 0],
    [0, 1, 0, 0],
    [0, 0, 1, -4],
    [0, 0, 0, 1]
  ]);

  userID = randomstring(5);

  update(true,true);

});

function randomstring(L){
  var s= '';
  var randomchar=function(){
    var n= Math.floor(Math.random()*62);
    if(n<10) return n; //1-10
    if(n<36) return String.fromCharCode(n+55); //A-Z
    return String.fromCharCode(n+61); //a-z
  }
  while(s.length< L) s+= randomchar();
  return s;
}

function prepForm(formData, jqForm, options) {
  for (var i=0; i < formData.length; i++) {
    if ( $.inArray(formData[i].name, deltaParams) >= 0 ) {
      console.log("Param changed: " + formData[i].name + " val: " + formData[i].value);
      var isComplex = false;
      if (paramDef[formData[i].name].type == "location") isComplex = true;

      formData[i].name = "shapeJS_" + formData[i].name;

      if (!isComplex && formData[i].value !== undefined && formData[i].type != "file") {
        // Don't JSON encode complex data types.
        formData[i].value = JSON.stringify(formData[i].value);
      }
    } else {
      formData.splice(i, 1);
      i--;
    }
  }

  // Add extra parameters not part of the form to formData
  $.each(extraParams, function(key, val) {
    formData.push({name: key, value: val});
  });

/*
  for (var i=0; i < formData.length; i++) {
    if (formData[i].type != "file") {
        formData[i].value = JSON.stringify(formData[i].value);
	} else {
	  checkFile(formData, i);
	}
  }

  for (var i=0; i < formData.length; i++) {
    console.log(formData[i].type + ": " + formData[i].name + " : " + formData[i].value);
  }
*/
}



function checkFile(formData, index) {
  var fileParam = formData[index].name;
  var fileNameParam = fileParam.replace("file", "filename");
  var val = document.getElementById(fileNameParam).value;

  if (isUriParam(fileNameParam)) {
    formData[index].type = "text";
    formData[index].name = fileParam;
    formData[index].value = val;//JSON.stringify(val);
  } else if (val.indexOf("/") > -1) {
    if (val.charAt(0) === "/") {
      val = val.substring(1);
    }
    var host = location.host;
    formData[index].type = "text";
    formData[index].name = fileParam;
    formData[index].value = "http://" + host + "/" + val;//JSON.stringify("http://" + host + "/" + val);
  }
}

/*************************************************/

function update(evalScript, showSpin) {
  if (typeof evalScript === "undefined" || evalScript === null || evalScript == true)
    evalScriptParams();

  if (renderReady()) {
    if (showSpin) spin();
    updateScene();
  }
}

/**
 * Checks if required parameters are set
 * TODO: Display indicator that not all required parameters are set
 */
function renderReady() {
  var ready = true;

  $.each(paramData, function(key, val) {
    if ( val === null && paramRequired[key] == true ) {
      ready = false;
      return false;
    }
  });

  return ready;
}

// Unit definitions
var units = "var MM = 0.001;\n";

function evalScriptParams() {
  var jsScript = editor.getValue();
  eval(units + jsScript);

  // Remove item from paramData that no longer exist in params declared in the script
  $.each(paramData, function(key, val) {
    var remove = true;

    if (typeof uiParams !== "undefined") {
      $.each(uiParams, function(i, param) {
        if (param.name === key) {
          remove = false;
          return false;   // breaks out of loop
        }
      });
    }

    // Remove from paramData and in the dom
    if (remove) {
      delete paramData[key];
      if ( $("#" + key + "-row").length > 0 )
        $("#" + key + "-row").remove();
    }
  });

  // Reset deltaParams since the script may have different parameters after evaluation of script
  deltaParams.length = 0;

  // Insert new params that do not already exist
  if (typeof uiParams !== "undefined") {
    $.each(uiParams, function(i, param) {
      var type = (param.type).toLowerCase();
      if ( $.inArray(type, inputTypes) >= 0) {
        if (paramData[param.name] === undefined) {
          insertInput(param);
        } else {
          // After resetting deltaParams, need to add params that were kept back to deltaParams
          deltaParams.push(param.name);
        }
      } else {
        console.log("Param type not allowed0:\n  Type: " + type + "\n  ID: " + param.name);
      }
    });
  }
}

function insertInput(param) {
  var pname_div = document.createElement("div");
  pname_div.setAttribute("class", "col1");
  pname_div.innerHTML = param.desc;

  setParamDef(param.name,param);

  switch ( (param.type).toLowerCase() ) {
    case "string":
      var pname_input = document.createElement("input");
      pname_input.setAttribute("type", "text");
      pname_input.setAttribute("name", param.name);
      pname_input.setAttribute("id", param.name);
      pname_input.setAttribute("value", param.default);
      pname_input.setAttribute("class", "col2-input");

      var pname_input_div = document.createElement("div");
      pname_input_div.setAttribute("class", "col2-3");
      pname_input_div.appendChild(pname_input);

      setParamVal(param.name, param.default);
      setParamRequirement(param.name, param.required);
      addParamUIListener(pname_input, param.name, (param.type).toLowerCase());
      break;
    case "double":
      var pname_input = document.createElement("input");
      pname_input.setAttribute("type", "range");
      pname_input.setAttribute("name", param.name);
      pname_input.setAttribute("id", param.name);
      pname_input.setAttribute("value", param.default);
      pname_input.setAttribute("min", param.rangeMin);
      pname_input.setAttribute("max", param.rangeMax);
      pname_input.setAttribute("step", param.step);
      pname_input.setAttribute("class", "range-slider");

      var pname_input_div = document.createElement("div");
      pname_input_div.setAttribute("class", "col2");
      pname_input_div.appendChild(pname_input);

      var pname_input_display = document.createElement("label");
      pname_input_display.setAttribute("id", param.name + "-display");
      pname_input_display.setAttribute("class", "col3");
      pname_input_display.innerHTML = param.default;

      setParamVal(param.name, param.default);
      setParamRequirement(param.name, param.required);
      addParamUIListener(pname_input, param.name, (param.type).toLowerCase());
      break;
    case "location":
      // Create text box to show the 3d location
      var pname_input = document.createElement("input");
      pname_input.setAttribute("type", "text");
      pname_input.setAttribute("name", param.name);
      pname_input.setAttribute("id", param.name);
      pname_input.setAttribute("value", JSON.stringify(param.default));
      pname_input.setAttribute("class", "col2-input");
      pname_input.setAttribute("readOnly", true);

      var pname_input_div = document.createElement("div");
      pname_input_div.setAttribute("class", "col2");
      pname_input_div.appendChild(pname_input);

      // Create a button to allow selecting a 3d position
      var button_div = document.createElement("div");
      button_div.setAttribute("class", "col3 param-button");
      button_div.setAttribute("onclick", "pickModeOn('" + param.name + "', this);");
      button_div.innerHTML = "Location";

      setParamVal(param.name, param.default);
      setParamRequirement(param.name, param.required);
      addParamUIListener(pname_input, param.name, (param.type).toLowerCase());
      break;
    case "uri":
      var fname_text = document.createElement("input");
      fname_text.setAttribute("type", "text");
      fname_text.setAttribute("name", "filename" + param.name);
      fname_text.setAttribute("id", "filename" + param.name);
      fname_text.setAttribute("class", "col2-input");
      fname_text.setAttribute("readOnly", true);

      var pname_input_div = document.createElement("div");
      pname_input_div.setAttribute("class", "col2");
      pname_input_div.appendChild(fname_text);

      var pname_input = document.createElement("input");
      pname_input.setAttribute("type", "file");
      pname_input.setAttribute("name", param.name);
      pname_input.setAttribute("id", param.name);
      pname_input.setAttribute("class", "upload");

      var span = document.createElement("span");
      span.innerHTML = "File";

      var button_div = document.createElement("div");
      button_div.setAttribute("class", "col3 fileUpload");
      button_div.innerHTML = "File";
      button_div.appendChild(pname_input);

      setParamVal(param.name, null);
      setParamRequirement(param.name, param.required);
      addFileParamUIListener(pname_input, param.name, fname_text, (param.type).toLowerCase());
      break;
    default:
      console.log("Param type not allowed:\n  Type: " + type + "\n  ID: " + param.name);
      return;
  }

  var parent = document.getElementById("parameters");
  var param_row = document.createElement("div");

  switch ( (param.type).toLowerCase() ) {
    case "uri":
      var fval_file_div = document.createElement("div");
//      fval_file_div.setAttribute("class", "param-val");
      fval_file_div.appendChild(pname_input_div);
      fval_file_div.appendChild(button_div);

	  param_row.setAttribute("id", param.name + "-row");
	  param_row.setAttribute("class", "param-row");
	  param_row.appendChild(pname_div);
      param_row.appendChild(fval_file_div);

      parent.appendChild(param_row);
      if ($(parent).hasClass('hidden')) {
        $(parent).removeClass('hidden')
      }

      break;
    case "location":
      var pval_div = document.createElement("div");
//      pval_div.setAttribute("class", "param-val");
      pval_div.appendChild(pname_input_div);
      pval_div.appendChild(button_div);

	  param_row.setAttribute("id", param.name + "-row");
	  param_row.setAttribute("class", "param-row");
	  param_row.appendChild(pname_div);
      param_row.appendChild(pval_div);

      parent.appendChild(param_row);
      if ($(parent).hasClass('hidden')) {
        $(parent).removeClass('hidden')
      }
    default:
      var pval_div = document.createElement("div");
//      pval_div.setAttribute("class", "param-val");
      pval_div.appendChild(pname_input_div);

      if (pname_input_display !== undefined && pname_input_display !== null) {
	      pval_div.appendChild(pname_input_display);
      }

	  param_row.setAttribute("id", param.name + "-row");
	  param_row.setAttribute("class", "param-row");
	  param_row.appendChild(pname_div);
      param_row.appendChild(pval_div);

      parent.appendChild(param_row);
      if ($(parent).hasClass('hidden')) {
        $(parent).removeClass('hidden')
      }

  }
}

function setParamDef(id, val) {
  console.log("Added param: " + id);
  console.log(val);
  paramDef[id] = val;
}

function setParamVal(id, val) {
  paramData[id] = val;
  if (val !== null) {
    deltaParams.push(id);
  }
}

function setParamRequirement(id, required) {
  var bool = true;
  if (typeof required !== "undefined" && required !== null) {
    bool = (required.toString()).toLowerCase();
    bool = (bool == "true") ? true : false
  }
  paramRequired[id] = bool;
}

function addParamUIListener(element, elementId, type) {
  switch (type) {
    case "string":
      $(element).on("input", function() {
        setParamVal( elementId, $(element).val() );
	    update(false, false);
      });
      $(element).on("change", function() {
        setParamVal( elementId, $(element).val() );
        update(false, false);
      });
      break;
    case "double":
      $(element).on("input", function() {
        setParamVal( elementId, $(element).val() );
	    var displayId = elementId + "-display";
	    if ( $("#" + displayId).length ) {
	      $("#" + displayId).html( $(element).val() );
	    }
	    update(false, false);
      });
      $(element).on("change", function() {
        setParamVal( elementId, $(element).val() );
        var displayId = elementId + "-display";
        if ( $("#" + displayId).length ) {
          $("#" + displayId).html( $(element).val() );
        }
        update(false, false);
      });
      break;

    case "location":
      $(element).on("change", function() {
        setParamVal( elementId, $(element).val() );
	    update(false, false);
      });
      break;
    default:
      console.log("Param type not allowed:\n  Type: " + type + "\n  ID: " + elementId);
      return;
  }
}

function addFileParamUIListener(element, elementId, nameHolderElement, type) {
  $(element).on("change", function() {
    var file = element.value;
    var tmp = file.split("\\");
    var fileName = tmp[tmp.length-1];
    nameHolderElement.value = fileName;
    setParamVal( elementId, fileName );
    update(false, true);
  });
}

function removeAllParams() {
  $("#parameters").empty();
  paramData = {};
  paramCount = 0;
}

function pickModeOn(dataContainerId, button) {
  pickMode = true;
  pickDataContainer = $("#" + dataContainerId);

  // Deselect current pick button
  if (curLocButton !== null) {
    $(curLocButton).removeClass("param-button-selected");
    $(curLocButton).addClass("param-button");
  }

  curLocButton = button;
  $(button).removeClass("param-button");
  $(button).addClass("param-button-selected");
  $("#render").removeClass("render-normal");
  $("#render").addClass("render-picking");
}

function pickModeOff(button) {
  pickMode = false;
  pickDataContainer = null;
  curLocButton = null;

  $(button).removeClass("param-button-selected");
  $(button).addClass("param-button");
  $("#render").removeClass("render-picking");
  $("#render").addClass("render-normal");
}

function toggleScriptView() {
  if ($("#viewer-container").is(':visible')) {
    hideViewer();
  } else {
    showViewer();
  }
}

function hideViewer() {
  $("#viewer-container").hide();
  $("#jscode").removeClass("jscode");
  $("#jscode").addClass("jscode-expanded");
  $("#expand-arrow").removeClass("expand-arrow");
  $("#expand-arrow").addClass("contract-arrow");
  $("#expand-arrow").attr( "src", "images/arrow_left.png" );
}

function showViewer() {
  $("#jscode").removeClass("jscode-expanded");
  $("#jscode").addClass("jscode");
  $("#expand-arrow").removeClass("contract-arrow");
  $("#expand-arrow").addClass("expand-arrow");
  $("#expand-arrow").attr( "src", "images/arrow_right.png" );
  $("#viewer-container").show();
}

function addMouseEventListeners() {
  $("#render").on("mousedown", function(event){
    event.preventDefault();
    mouseDown = true;
    dragStart.x = event.clientX;
    dragStart.y = event.clientY;

    var handlers = {
      mousemove : function(event){
        event.preventDefault();

        if (event.button == 0) {
          var dx = event.clientX - dragStart.x;
          var dy = event.clientY - dragStart.y;
          rotateModel(dx, dy, null, null);

          dragStart.x = event.clientX;
          dragStart.y = event.clientY;
        }
      },
      mousedown : function(event){
        event.preventDefault();

        if (pickMode && event.button == 2) {
          if (renderReady()) {
            pickModel(event, $("#render"));
          }
          mouseDown = false;
        }
      },
      mouseup : function(event){
        $(this).off(handlers);
        mouseDown = false;
      }
    };
    $(document).on(handlers);
  });

  $("#render").load(function() {
    loading = false;
    unspin();
  });

  $("#render").error(function() {
    // failed to load, use full render path
    loading = false;
    forceFull = true;
    unspin();
  });

  //Firefox
  $("#render").bind('DOMMouseScroll', function(e){
    if (e.originalEvent.detail > 0) {
      zoom -= Math.abs(zoom) / 4;
    } else if (e.originalEvent.detail < 0) {
      zoom += (Math.abs(zoom) + 1) / 4;
    }

    zoomModel();

    //prevent page fom scrolling
    return false;
  });

  //IE, Opera, Safari
  $("#render").bind('mousewheel', function(e){
    if (e.originalEvent.wheelDelta > 0) {
      zoom += Math.abs(zoom) / 4;
    } else if (e.originalEvent.wheelDelta < 0) {
      zoom -= (Math.abs(zoom) + 1) / 4;
    }

    zoomModel();

    //prevent page fom scrolling
    return false;
  });

  // Handle key events over render
  $("#render").on("mouseover", function(event){
    var handlers = {
      keydown : function(event){
        onKeyPress(event);
      },
      mouseout : function(event){
        $(this).off(handlers);
      },
    };
    $(document).on(handlers);
  });

  // Evaluate script, and update UI and scene if script changes
  editor.on("blur", function() {
    if (scriptChanged) {
      update(true, true);
      scriptChanged = false;
    }
  });

  editor.on("change", function() {
    scriptChanged = true;
  });
}

function onKeyPress(event) {
  var charCode = (typeof event.which == "number") ? event.which : event.keyCode;

  switch (charCode) {
    case 27:              // escape
      pickModeOff(curLocButton);
      break;
    case 39:              // right arrow
      rotateModel(null, null, 0, radiansByArrow);
      break;
    case 37:              // left arrow
      rotateModel(null, null, 0, -radiansByArrow);
      break;
    case 38:              // up arrow
      rotateModel(null, null, radiansByArrow, 0);
      break;
    case 40:              // down arrow
      rotateModel(null, null, -radiansByArrow, 0);
      break;
    default:
      break;
  }
}
</script>

<div class="container">

<div id="main-box">

<div class="quality-control">
  <div id="save-scene" class="menu-button" onclick="saveScene()">Save</div>
  <div id="camera"><img src="images/icon-camera-128.png" class="camera" onclick="renderHighQuality(true)"/></div>
  <div id="quality-select">
    <select id="render-quality" class="quality-select" onchange="setQuality(this.value)">
      <option value="0.5" selected="selected">Normal</option>
	  <option value="0.25">Draft</option>
    </select><br/><br/>
  </div>
</div>

<!-- left column -->
<div id="jscode" class="jscode">
<textarea id="code" name="code" placeholder="">
var uiParams = [
	{
       "name": "period",
       "desc": "Period",
       "type": "double",
       "rangeMin": 1,
       "rangeMax": 21,
       "step": 1,
       "default": 18
	},
	{
       "name": "thickness",
       "desc": "Thickness",
       "type": "double",
       "rangeMin": 1,
       "rangeMax": 5,
       "step": 0.5,
       "default": 2
	}
];
function main(args) {
	var radius = 25 * MM;
	var sphere = new Sphere(radius);
	var gyroid = new VolumePatterns.Gyroid(args['period']*MM, args['thickness']*MM);
	var intersect = new Intersection();
	intersect.setBlend(2*MM);
	intersect.add(sphere);
	intersect.add(gyroid);
	var s = 25*MM;
	return new Shape(intersect,new Bounds(-s,s,-s,s,-s,s));
}

</textarea>
<div id="preview-button" onclick="//update(true,true);" class="submit-generate">Generate</div>
<!--<div id="loading" class="loading">Generating...<img width="18" height="18" alt="" src="images/loading.gif" /></div> -->
<div id="save-button" onclick="" class="submit-save">Save model</div>
<div id="saving">Saving...<img width="18" height="18" alt="" src="images/loading.gif" /></div>
<div><img id="expand-arrow" src="images/arrow_right.png" class="expand-arrow" onclick="toggleScriptView()"/></div>
</div>



<style type="text/css">
.CodeMirror {
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}
.CodeMirror pre.CodeMirror-placeholder {
  color: #999;
}
.CodeMirror-selected  { background-color: blue !important; }
.CodeMirror-selectedtext { color: white !important; }
.CodeMirror-activeline-background {background: #e8f2ff !important;}
</style>
<script>
  var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
    mode: "javascript",
	lineNumbers: true,
	matchBrackets: true,
	continueComments: "Enter",
    styleSelectedText: true,
    gutters: ["CodeMirror-lint-markers"],
    lintWith: CodeMirror.javascriptValidator,
    styleActiveLine: true,
  });
</script>

<!-- middle column -->
<div id="viewer-container" class="viewer-container">
<div class="viewer">
<div id="model-container">
<div id="loading" class='loading'>
  <div class="x3dom-view-loading"></div>
</div>
<div id="image-viewer" width="512px" height="540px"><img id="render" class="render-normal"/></div>
</div>
</div>
<div><input type="text" name="title" id="title" class="title" value="Model Title" /></div>
<div id="upload-button" onclick="" class="submit-upload">Upload</div>
<div id="uploading">Uploading...<img width="18" height="18" alt="" src="images/loading.gif" /></div>
</div>

<form id="form" action="" method="POST">
<div id="parameters" class="parameter-container hidden"></div>
</form>

<div id="logger" class="console"></div>

</div>
</div>

</body>
</html>